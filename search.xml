<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>kubernetes| fluent-bit日志采集系统配置</title>
    <url>/2023/02/28/kubernetes/</url>
    <content><![CDATA[<p>排查问题的时候,loghub上的日志是混在一起的,我们希望日志能有一个标签去定位对应的pod,然后通过pod去检索出对应的日志方便我们查看上下文.<br>这个时候就要去集群管理页面上去修改对应的fluent-bit配置就行,我们这里的集群管理用的是rancher,登录rancher选择storage-&gt;ConfigMaps-&gt;fluent-bit-&gt;EditConfig.<br>修改配置如下:</p>
<p>custom_parsers.conf</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[PARSER]</span><br><span class="line">    Name docker_no_time</span><br><span class="line">    Format json</span><br><span class="line">    Time_Keep Off</span><br><span class="line">    Time_Key time</span><br><span class="line">    Time_Format %Y-%m-%dT%H:%M:%S.%L</span><br><span class="line"></span><br><span class="line">[PARSER]</span><br><span class="line">    Name                container_firstline</span><br><span class="line">    Format              regex</span><br><span class="line">    Regex               (?&lt;log&gt;(?&lt;=&quot;log&quot;:&quot;)\S(?!\.).*?)(?&lt;!\\)&quot;.*(?&lt;stream&gt;(?&lt;=&quot;stream&quot;:&quot;).*?)&quot;.*(?&lt;time&gt;\d&#123;4&#125;-\d&#123;1,2&#125;-\d&#123;1,2&#125;T\d&#123;2&#125;:\d&#123;2&#125;:\d&#123;2&#125;\.\w*).*(?=&#125;)</span><br><span class="line">    Time_Key            time</span><br><span class="line">    Time_Format         %Y-%m-%dT%H:%M:%S.%LZ</span><br></pre></td></tr></table></figure>

<p>fluent-bit.conf</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[SERVICE]</span><br><span class="line">    Daemon Off</span><br><span class="line">    Flush 1</span><br><span class="line">    Log_Level info</span><br><span class="line">    Parsers_File parsers.conf</span><br><span class="line">    Parsers_File custom_parsers.conf</span><br><span class="line">    HTTP_Server On</span><br><span class="line">    HTTP_Listen 0.0.0.0</span><br><span class="line">    HTTP_Port 2020</span><br><span class="line">    Health_Check On</span><br><span class="line">    storage.path              /var/fluent-bit/state/flb-storage/</span><br><span class="line">    storage.sync              normal</span><br><span class="line">    storage.checksum          off</span><br><span class="line">    storage.backlog.mem_limit 10M</span><br><span class="line"></span><br><span class="line">[INPUT]</span><br><span class="line">    Name tail</span><br><span class="line">    Path xxxxxxxx.log  # 对应的日志文件</span><br><span class="line">    Tag kube.*</span><br><span class="line">    Docker_Mode         On</span><br><span class="line">    Docker_Mode_Flush   5</span><br><span class="line">    Docker_Mode_Parser  container_firstline</span><br><span class="line">    Parser              docker</span><br><span class="line">    DB                  /var/fluent-bit/state/flb_container.db</span><br><span class="line">    Mem_Buf_Limit       5MB</span><br><span class="line">    Skip_Long_Lines     On</span><br><span class="line">    Refresh_Interval    10</span><br><span class="line">    Rotate_Wait         30</span><br><span class="line">    storage.type        filesystem</span><br><span class="line"></span><br><span class="line">[FILTER]</span><br><span class="line">    Name             kubernetes</span><br><span class="line">    Match            kube.*   # 匹配模式改成kube.*</span><br><span class="line">    Kube_URL         https://kubernetes.default.svc:443</span><br><span class="line">    Kube_CA_File     /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">    Kube_Token_File  /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">    Labels false</span><br><span class="line">    Annotations false</span><br><span class="line"></span><br><span class="line">[Filter]</span><br><span class="line">    Name    nest</span><br><span class="line">    Match    kube.*</span><br><span class="line">    Operation    lift</span><br><span class="line">    Nested_under    kubernetes</span><br><span class="line">    Add_prefix    kubernetes_</span><br><span class="line"></span><br><span class="line">[Filter]</span><br><span class="line">    Name    modify</span><br><span class="line">    Match    kube.*</span><br><span class="line">    Remove    kubernetes_pod_id  # Remove可以移除掉你不关心的参数</span><br><span class="line">    Remove    kubernetes_namespace_name</span><br><span class="line">    Remove    kubernetes_container_hash</span><br><span class="line">    Remove    kubernetes_container_image</span><br><span class="line">    Remove    kubernetes_container_name</span><br><span class="line">    Remove    kubernetes_docker_id</span><br><span class="line"></span><br><span class="line">[OUTPUT]</span><br><span class="line">    Name kinesis_streams</span><br><span class="line">    Match             kube.*</span><br><span class="line">    Region us-west-1	    # aws区域</span><br><span class="line">    Stream LogHub-xxxxxxxx  # loghub配置流</span><br><span class="line">    Retry_Limit False</span><br><span class="line">    time_key time</span><br></pre></td></tr></table></figure>
<p>重启一下fluent-bit就行了.</p>
<p>这里调试的过程中发现的一些需要注意的问题:</p>
<ol>
<li>match 要给成 kube.*</li>
</ol>
]]></content>
      <tags>
        <tag>kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title>python| pip下载包太慢的问题</title>
    <url>/2023/02/28/python/</url>
    <content><![CDATA[<p>国内编写python项目需要通过pip去下载对应的依赖,有时候会很慢,可以通过pip配置来修改国内镜像源</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">pip3 config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="line">pip3 config set install.trusted-host mirrors.aliyun.com</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>vim |我的vim的基本配置</title>
    <url>/2023/02/28/vim/</url>
    <content><![CDATA[<p>工作中无论是终端还是IDE都是习惯用vim进行代码编辑, 这边存一下vim的基本配置, 方便切换电脑的时候能快速把编辑环境配置好.</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;set termguicolors  &quot;</span> 打开 <span class="number">24</span> 位真彩色支持                     </span><br><span class="line"><span class="string">&quot;set colorcolumn=80  &quot;</span> 高亮第<span class="number">80</span>列                          </span><br><span class="line"><span class="string">&quot;set relativenumber                    &quot;</span> setting <span class="built_in">line</span> in relative <span class="keyword">mode</span></span><br><span class="line"><span class="comment">&quot;highlight CursorColumn cterm=NONE ctermbg=gray ctermfg=yellow guibg=NONE guifg=NONE </span></span><br><span class="line"><span class="comment">&quot;highlight CursorLine  cterm=NONE ctermbg=gray ctermfg=yellow guibg=NONE guifg=NONE </span></span><br><span class="line"><span class="comment">&quot;set colorcolumn=100                                 </span></span><br><span class="line"><span class="keyword">set</span> cursorcolumn   <span class="comment">&quot; 高亮显示当前列                        </span></span><br><span class="line"><span class="keyword">set</span> cursorline    <span class="comment">&quot; 高亮显示当前行                        </span></span><br><span class="line"><span class="keyword">set</span> ignorecase    <span class="comment">&quot; 搜索的时候忽略大小字字母                   </span></span><br><span class="line"><span class="keyword">set</span> smartcase     <span class="comment">&quot; 若搜索内容中有大写字母，则不再忽略大小写           </span></span><br><span class="line"><span class="keyword">set</span> exrc                         <span class="comment">&quot; exec command in init.vim </span></span><br><span class="line"><span class="keyword">set</span> secure                        <span class="comment">&quot; safely do command above  </span></span><br><span class="line"><span class="keyword">set</span> autochdir                       <span class="comment">&quot; auto change directory   </span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">number</span>                        <span class="comment">&quot; setting line       </span></span><br><span class="line"><span class="keyword">set</span> noexpandtab                      <span class="comment">&quot; use only &#x27;\t&#x27; as tab   </span></span><br><span class="line"><span class="keyword">set</span> tabstop=<span class="number">4</span>                       <span class="comment">&quot; show how many space for a &#x27;\t&#x27;</span></span><br><span class="line"><span class="keyword">set</span> <span class="built_in">shiftwidth</span>=<span class="number">2</span>                     <span class="comment">&quot; use how many space for &gt;&gt; or &lt;&lt; key</span></span><br><span class="line"><span class="keyword">set</span> softtabstop=<span class="number">2</span>                     <span class="comment">&quot; use how many space when pressing tab</span></span><br><span class="line"><span class="keyword">set</span> autoindent                                    </span><br><span class="line"><span class="keyword">set</span> <span class="keyword">list</span>                         <span class="comment">&quot; show hiding char     </span></span><br><span class="line"><span class="keyword">set</span> listchars=<span class="keyword">tab</span>:\|\ ,trail:·              <span class="comment">&quot; define tab and space show</span></span><br><span class="line"><span class="keyword">set</span> scrolloff=<span class="number">4</span>                      <span class="comment">&quot; least amount line below and above the cursor</span></span><br><span class="line"><span class="keyword">set</span> ttimeoutlen=<span class="number">0</span>                     <span class="comment">&quot; set never wait for key  </span></span><br><span class="line"><span class="keyword">set</span> notimeout                                     </span><br><span class="line"><span class="keyword">set</span> viewoptions=<span class="built_in">cursor</span>,folds,slash,unix          <span class="comment">&quot; remember where to recover cursor</span></span><br><span class="line"><span class="keyword">set</span> wrap                         <span class="comment">&quot; auto line feed      </span></span><br><span class="line"><span class="keyword">set</span> tw=<span class="number">0</span>                         <span class="comment">&quot; text width for automatically wrapping</span></span><br><span class="line"><span class="keyword">set</span> indentexpr=                                                                                                          </span><br><span class="line"><span class="keyword">set</span> splitright                                    </span><br><span class="line"><span class="keyword">set</span> splitbelow                                    </span><br><span class="line"><span class="keyword">set</span> noshowmode                      <span class="comment">&quot; not showing current mode</span></span><br><span class="line"><span class="keyword">set</span> showcmd                        <span class="comment">&quot; show cmd inputing like key combine</span></span><br><span class="line"><span class="keyword">set</span> wildmenu                       <span class="comment">&quot; auto finish vim command  </span></span><br><span class="line"><span class="keyword">set</span> ignorecase                      <span class="comment">&quot; ignore case when searching</span></span><br><span class="line"><span class="keyword">set</span> smartcase                       <span class="comment">&quot; ignore case only on searching</span></span><br><span class="line"><span class="keyword">set</span> shortmess+=<span class="keyword">c</span>                     <span class="comment">&quot; don&#x27;t show useless msg  </span></span><br><span class="line"><span class="keyword">set</span> inccommand=<span class="keyword">split</span>                   <span class="comment">&quot; show substitution automatically</span></span><br><span class="line"><span class="keyword">set</span> completeopt=longest,noinsert,menuone,noselect,preview <span class="comment">&quot; complete opject with a menue</span></span><br><span class="line"><span class="keyword">set</span> ttyfast                        <span class="comment">&quot; make scrolling faster   </span></span><br><span class="line"><span class="keyword">set</span> visualbell                      <span class="comment">&quot; flash screen to notify error</span></span><br><span class="line"><span class="keyword">set</span> updatetime=<span class="number">100</span>                                  </span><br><span class="line"><span class="keyword">set</span> virtualedit=block                                 </span><br><span class="line"><span class="keyword">set</span> lazyredraw                                    </span><br><span class="line"><span class="keyword">set</span> re=<span class="number">0</span>                         <span class="comment">&quot;make increase speed    </span></span><br><span class="line"><span class="comment">&quot; set folding paragraph                                </span></span><br><span class="line"><span class="keyword">set</span> foldmethod=<span class="built_in">indent</span>                                 </span><br><span class="line"><span class="keyword">set</span> <span class="built_in">foldlevel</span>=<span class="number">99</span>                                   </span><br><span class="line"><span class="keyword">set</span> foldenable                                    </span><br><span class="line"><span class="keyword">set</span> formatoptions-=<span class="keyword">tc</span>                                 </span><br><span class="line"><span class="comment">&quot; keep undo or temp file                               </span></span><br><span class="line"><span class="keyword">set</span> hidden                                     </span><br></pre></td></tr></table></figure>

<p>不过有时间的话一般都是配置neovim,我的neovim配置仓库是: <a class="link"   href="https://github.com/ribincao/ribin-neovim.git" >https://github.com/ribincao/ribin-neovim.git<i class="fas fa-external-link-alt"></i></a></p>
]]></content>
      <tags>
        <tag>vim</tag>
      </tags>
  </entry>
</search>
